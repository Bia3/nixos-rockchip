{ config, pkgs, lib, modulesPath, ... }:
{
  hardware.deviceTree.overlays = [ {
    name = "pcie-fix";
    dtsText = ''
      /dts-v1/;
      /plugin/;

      / {
        compatible = "pine64,soquartz-model-a", "pine64,soquartz-cm4io", "pine64,soquartz-blade", "pine64,soquartz", "rockchip,rk3566";
      };

      &pcie3x1 {
        reg = <0x3 0xc0400000 0x0 0x00400000>,
              <0x0 0xfe270000 0x0 0x00010000>,
              <0x0 0xf2000000 0x0 0x00100000>;
        ranges = <0x01000000 0x0 0xf2100000 0x0 0xf2100000 0x0 0x00100000>,
                 <0x02000000 0x0 0xf2200000 0x0 0xf2200000 0x0 0x01e00000>,
                 <0x03000000 0x0 0x40000000 0x3 0x40000000 0x0 0x40000000>;
      }


      &pcie3x2 {
        reg = <0x3 0xc0800000 0x0 0x00400000>,
              <0x0 0xfe280000 0x0 0x00010000>,
              <0x0 0xf0000000 0x0 0x00100000>;
        ranges = <0x01000000 0x0 0xf0100000 0x0 0xf0100000 0x0 0x00100000>,
                 <0x02000000 0x0 0xf0200000 0x0 0xf0200000 0x0 0x01e00000>,
                 <0x03000000 0x0 0x40000000 0x3 0x80000000 0x0 0x40000000>;
      }

      &pcie2x1 {
        reg = <0x3 0xc0000000 0x0 0x00400000>,
              <0x0 0xfe260000 0x0 0x00010000>,
              <0x0 0xf4000000 0x0 0x00100000>;
        ranges = <0x01000000 0x0 0xf4100000 0x0 0xf4100000 0x0 0x00100000>,
                 <0x02000000 0x0 0xf4200000 0x0 0xf4200000 0x0 0x01e00000>,
                 <0x03000000 0x0 0x40000000 0x3 0x00000000 0x0 0x40000000>;
      }
    '';
  } ];
}
